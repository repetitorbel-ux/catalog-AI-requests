# Обзор проекта: Каталог запросов

## 1. Суть и назначение проекта

Это веб-приложение на Flask, предназначенное для ведения иерархического каталога ссылок и заметок. Проект позволяет пользователям организовывать информацию в виде трехуровневой структуры: **Категория -> Подкатегория -> Запись**. Каждая запись может содержать несколько URL-ссылок.

Приложение обладает веб-интерфейсом для выполнения всех CRUD-операций (создание, чтение, редактирование, удаление), а также включает функционал для экспорта данных и их резервного копирования.

## 2. Ключевые технологии

- **Бэкенд:** Python 3.11
- **Фреймворк:** Flask
- **База данных:** PostgreSQL (подключение через `psycopg2-binary`)
- **ORM:** SQLAlchemy (с использованием `Flask-SQLAlchemy`)
- **Тестирование:** Pytest с `pytest-flask`
- **Окружение:** Conda (`catalog_env`)
- **Резервное копирование:** Утилиты PostgreSQL (`pg_dump`, `pg_restore`)

## 3. Анализ структуры и файлов проекта

Ниже представлен разбор основных файлов и их роли в проекте.

---

### `app.py`
- **Назначение:** Главный файл приложения, точка входа.
- **Анализ и особенности:**
    - Реализован по паттерну **"Фабрика приложений"** (функция `create_app`). Это позволяет создавать разные экземпляры приложения, что критически важно для корректного тестирования.
    - Загружает конфигурацию из файла `config.py`.
    - Инициализирует расширения (например, `db` для SQLAlchemy).
    - Регистрирует "чертежи" (blueprints), в данном случае `catalog_bp` из `routes.py`.
    - При запуске выполняет `db.create_all()`, чтобы создать все необходимые таблицы в БД, если их еще нет.

---

### `config.py`
- **Назначение:** Файл конфигурации.
- **Анализ и особенности:**
    - Содержит `SECRET_KEY` для подписи сессий, что необходимо для работы flash-сообщений.
    - Хранит строку подключения к базе данных `SQLALCHEMY_DATABASE_URI`. Предусмотрена возможность быстрого переключения между удаленной (Neon) и локальной (для разработки) базой данных.
    - Содержит настройки для повышения отказоустойчивости подключений к БД (`SQLALCHEMY_POOL_RECYCLE`, `SQLALCHEMY_POOL_PRE_PING`), что важно для serverless-баз.
    - Определяет пути к папке с бэкапами (`BACKUP_DIR`) и файлу для экспорта (`MARKDOWN_FILE`).

---

### `models.py`
- **Назначение:** Описание структуры базы данных в виде Python-классов (моделей SQLAlchemy).
- **Анализ и особенности:**
    - Определены 4 модели: `Category`, `Subcategory`, `Entry`, `Url`.
    - Между моделями настроены иерархические связи `one-to-many` с помощью `db.relationship`.
    - Использование `cascade='all, delete-orphan'` обеспечивает автоматическое удаление дочерних объектов (например, подкатегорий при удалении категории), что поддерживает целостность данных.

---

### `routes.py`
- **Назначение:** Основная логика приложения. Обработка всех HTTP-запросов.
- **Анализ и особенности:**
    - Вся логика сгруппирована в `Blueprint` с именем `catalog_bp` для лучшей структуризации.
    - Реализованы маршруты для всех CRUD-операций с категориями, подкатегориями и записями.
    - Содержит маршруты для служебных функций: `/backup`, `/restore`, `/export`.
    - Реализованы AJAX-эндпоинты (`/get_subcategories`, `/get_entries` и др.) для динамической подгрузки данных в интерфейсе без перезагрузки страницы.
    - Интегрирована система **flash-сообщений** для информирования пользователя о результатах операций.

---

### `utils.py`
- **Назначение:** Вспомогательные функции, вынесенные из основной логики.
- **Анализ и особенности:**
    - Содержит надежную реализацию функций `create_backup` и `restore_backup`.
    - Для работы с PostgreSQL используются ее нативные утилиты `pg_dump` и `pg_restore`, вызываемые через `subprocess`. Это правильный подход для создания корректных бэкапов.
    - Аутентификация для этих утилит происходит безопасным способом через переменные окружения, которые формируются из `SQLALCHEMY_DATABASE_URI`.

---

### `templates/interface.html`
- **Назначение:** Единственный HTML-шаблон, формирующий весь пользовательский интерфейс.
- **Анализ и особенности:**
    - Использует шаблонизатор `Jinja2` для динамической генерации списков категорий и бэкапов.
    - Содержит значительный объем JavaScript-кода для динамического взаимодействия с пользователем (обновление выпадающих списков, загрузка данных записей по клику).
    - Реализован интерфейс с вкладками для разделения функционала (добавление, редактирование, удаление, бэкап, восстановление).
    - Включает блок для отображения flash-сообщений.

---

### `static/style.css`
- **Назначение:** Файл стилей для `interface.html`.
- **Анализ и особенности:**
    - Использует `flexbox` для построения основной разметки.
    - Содержит стили для всех элементов интерфейса, включая интерактивные состояния (hover, active) и классы для flash-сообщений (`.success`, `.error`).

---

### `tests/test_app.py`
- **Назначение:** Набор автоматизированных тестов для проверки работоспособности приложения.
- **Анализ и особенности:**
    - Использует `pytest` и фикстуры для создания чистого окружения для каждого теста.
    - Применяет "фабрику приложений" для запуска тестов на изолированной **базе данных SQLite в памяти**, что гарантирует независимость тестов и не затрагивает рабочую БД.
    - Содержит базовые тесты для проверки главной страницы и основной функции добавления записи.

---

### `README.md`
- **Назначение:** Главный документ проекта, инструкция по установке и запуску.
- **Анализ и особенности:**
    - Содержит полное и пошаговое руководство для нового разработчика по развертыванию проекта с нуля, включая создание Conda-окружения, установку зависимостей и запуск приложения и тестов.
