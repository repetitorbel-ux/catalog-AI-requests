# Обзор и Архитектура проекта: Каталог запросов

## 1. Суть и назначение проекта

Это веб-приложение на Flask, предназначенное для ведения иерархического каталога ссылок и заметок. Проект позволяет пользователям организовывать информацию в виде трехуровневой структуры: **Категория -> Подкатегория -> Запись**. Каждая запись может содержать несколько URL-ссылок.

Приложение обладает веб-интерфейсом для выполнения всех CRUD-операций (создание, чтение, редактирование, удаление), а также включает функционал для экспорта данных и их резервного копирования.

## 2. Установка и запуск

1.  **Клонируйте репозиторий:**
    ```shell
    git clone https://github.com/repetitorbel-ux/catalog-AI-requests
    cd catalog-AI-requests
    ```

2.  **Создайте окружение Conda:**
    Убедитесь, что у вас установлен Miniconda/Anaconda. Затем выполните команду для создания окружения с нужной версией Python:
    ```shell
    conda create --name catalog_env python=3.11
    ```
    Согласитесь на установку пакетов, введя `y`.

3.  **Активируйте окружение:**
    ```shell
    conda activate catalog_env
    ```

4.  **Установите зависимости:**
    Находясь в активированном окружении, установите все библиотеки из файла `requirements.txt`:
    ```shell
    pip install -r requirements.txt
    ```

5.  **Запустите приложение:**
    Вы можете использовать `start_catalog_bd.bat` или выполнить команду:
    ```shell
    flask run
    ```
    Приложение будет доступно по адресу `http://127.0.0.1:5000`.

## 3. Технологический стек и версии
- **Backend:** Python 3.11, Flask 2.x
- **База данных:** PostgreSQL (+ psycopg2-binary), SQLAlchemy (Flask-SQLAlchemy)
- **Фронтенд:** Vanilla JS (ES6 Class), CSS Flexbox
- **Тестирование:** Pytest, pytest-flask
- **Окружение:** Conda (`catalog_env`)
- **Резервное копирование:** Нативные утилиты PostgreSQL (`pg_dump`, `pg_restore`)

## 4. Ключевые компоненты и паттерны

### `app.py`
- **Паттерн:** Фабрика приложений (`create_app()`).
- **Назначение:** Точка входа. Инициализирует конфиг, БД, регистрирует blueprints и определяет CLI-команды.
- **Особенности:**
    - Для тестов создается отдельный экземпляр приложения с тестовой конфигурацией.
    - Содержит обработчик событий SQLAlchemy, который условно выполняет `SET search_path TO public` только для диалекта PostgreSQL, обеспечивая совместимость с тестовой БД SQLite.

### `config.py`
- **Содержит:** `SECRET_KEY`, `SQLALCHEMY_DATABASE_URI` и другие пути.
- **Загрузка конфигурации:** В самом начале файла используется библиотека `python-dotenv` для загрузки переменных из файла `.env`. Это позволяет безопасно хранить секреты (`SECRET_KEY`, `DATABASE_URL`) вне системы контроля версий.
- **Важно:** Для подключения к БД используется переменная окружения `DATABASE_URL`. Конфиг адаптирован для serverless-БД (пулы соединений, `SQLALCHEMY_POOL_RECYCLE`, `SQLALCHEMY_POOL_PRE_PING`).

### `models.py`
- **Сущности:** `Category` -> `Subcategory` -> `Entry` -> `Url`.
- **Связи:** Иерархические `one-to-many` с каскадным удалением (`cascade='all, delete-orphan'`).
- **Поля:** Основные поля `name`, `description` (для `Url`), связи `foreign_key`.

### `routes.py`
- **Структура:** Все эндпоинты сгруппированы в Blueprint `catalog_bp`.
- **Функционал:**
  - CRUD для всех сущностей. Операция добавления (`/add`) реализована через AJAX и возвращает JSON.
  - AJAX-эндпоинты для динамической подгрузки списков (`/get_subcategories`, `/get_entries`).
  - Сервисные эндпоинты (`/backup`, `/restore`, `/export`).
- **Важно:** Для AJAX-операций используются JSON-ответы, для стандартных форм - flash-сообщения.

### `utils.py`
- **Содержит:** Функции `create_backup()` и `restore_backup()`.
- **Реализация:** Используются нативные утилиты PostgreSQL, вызываемые через `subprocess`.
- **Безопасность:** Аутентификация через переменные окружения из `SQLALCHEMY_DATABASE_URI`.

### `templates/interface.html`
- **Особенность:** Весь интерфейс — один файл. **Не содержит JavaScript**, вся динамика вынесена в `static/js/app.js`.
- **Структура:** Вкладки для различных операций (добавление, редактирование, удаление, бэкап).

### `static/style.css`
- **Подход:** Flexbox для layout.
- **Содержит:** Стили для всех элементов интерфейса, включая состояния (hover, active), flash-сообщения и временную подсветку новых элементов.

### `static/js/app.js`
- **Подход:** ООП, весь код инкапсулирован в класс `CatalogApp`.
- **Назначение:** Управляет всей динамикой интерфейса: переключение вкладок, обработка форм, отправка AJAX-запросов, динамическое обновление DOM без перезагрузки страницы.
- **Обработка AJAX:** Все AJAX-запросы выполняются через единый асинхронный метод `_fetchJSON`. Этот метод-враппер стандартизирует обработку ответов и ошибок (включая сетевые ошибки и ошибки сервера), показывая пользователю flash-сообщения в случае сбоя.
- **Важно:** Для обработки событий на динамически созданных элементах используется делегирование событий.

### `tests/test_app.py`
- **Стратегия:** Использует фабрику приложений и БД SQLite в памяти для изоляции тестов.
- **Покрытие:** Базовые тесты главной страницы, операций добавления (стандартный POST и AJAX), и других эндпоинтов.